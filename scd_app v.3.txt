import streamlit as st
import matplotlib.pyplot as plt
import numpy as np

st.title("Single-Case Design Graph Generator (Multiple Phases)")

# Number of phases
num_phases = st.number_input("How many phases?", min_value=1, max_value=5, value=2)

# Input fields for each phase
phase_names = []
phase_data = []

for i in range(num_phases):
    name = st.text_input(f"Name for Phase {i+1}", value=chr(65+i))  # Defaults to A, B, C...
    data_str = st.text_input(f"Data for {name} (comma-separated)", "")

    if data_str:
        data = []
        for x in data_str.split(","):
            x = x.strip().lower()
            if x in ["", "x", "-", "na"]:
                data.append(np.nan)
            else:
                try:
                    data.append(float(x))
                except ValueError:
                    st.error(f"Invalid entry '{x}' in {name}. Use numbers or 'x' for missing data.")
                    data = []
                    break
    else:
        data = []

    phase_names.append(name)
    phase_data.append(data)

# Axis labels and scaling
graph_title = st.text_input("Graph Title", "Single-Case Design Graph")
y_label = st.text_input("Dependent variable (Y-axis label)", "% correct responses")
x_label = st.text_input("Unit of measurement (X-axis label)", "Sessions")
y_min = st.number_input("Minimum Y value", value=0)
y_max = st.number_input("Maximum Y value", value=100)
y_tick = st.number_input("Y tick interval", value=10)

# Generate graph
if st.button("Generate Graph"):
    fig, ax = plt.subplots(figsize=(9, 5))
    colors = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd"]
    markers = ["o", "s", "D", "^", "v"]

    current_x = 1
    midpoints = []

    # Plot each phase
    for idx, (name, data) in enumerate(zip(phase_names, phase_data)):
        if not data:
            continue
        x_vals = np.arange(current_x, current_x + len(data))
        ax.plot(
            x_vals,
            data,
            color=colors[idx % len(colors)],
            marker=markers[idx % len(markers)],
            label=name,
            linewidth=2,
            markersize=6
        )
        mid = current_x + (len(data) - 1) / 2
        midpoints.append((mid, name))
        current_x += len(data)
        if idx < len(phase_data) - 1:
            ax.axvline(x=current_x - 0.5, color="black", linestyle="--")

    # Add phase labels centered above each section
    y_top = y_max + (y_max - y_min) * 0.05
    for mid, name in midpoints:
        ax.text(mid, y_top, name, ha="center", va="bottom", fontsize=10, fontweight="bold")

    # Axis formatting
    ax.set_title(graph_title, fontsize=13, pad=20)
    ax.set_xlabel(x_label)
    ax.set_ylabel(y_label)
    ax.set_ylim(y_min, y_max + (y_max - y_min) * 0.1)
    ax.set_yticks(np.arange(y_min, y_max + 0.0001, y_tick))

    # Hide top and right spines for a clean open look
    ax.spines["top"].set_visible(False)
    ax.spines["right"].set_visible(False)

    # Legend off to the right
    ax.legend(frameon=False, loc="center left", bbox_to_anchor=(1.02, 0.5))

    st.pyplot(fig)
